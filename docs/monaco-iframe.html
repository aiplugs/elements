<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>monaco editor</title>
  <style>
    html, body, #editor {
      margin: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
  </style>
  <script src="//unpkg.com/monaco-editor/min/vs/loader.js"></script>
</head>
<body>
  <div id="editor"></div>
  <script>
    const qp = (location.search || '?').slice(1).split('&').map(kv => kv.split('=')).reduce((obj, kv) => { obj[kv[0]] = kv[1]; return obj; }, {});
    window.MonacoEnvironment = { getWorkerUrl: function (workerId, label) { return './monaco-editor-worker-loader-proxy.js' } };
    require.config({ paths: { 'vs': '//unpkg.com/monaco-editor/min/vs' } });
    require(['vs/editor/editor.main'], () => {
      const editor = monaco.editor.create(document.getElementById('editor'), { language: 'html' });
      editor.onDidBlurEditor(() =>{
        window.parent.postMessage(JSON.stringify({type:"monaco.blur", value: editor.getValue()}), qp.parent);
      })
      window.addEventListener('message', evt => {
        if (evt.origin !== qp.parent)
          return
        
        const data = JSON.parse(evt.data)
        if (data.type === 'monaco.update.opts') {
          const options = Object.assign({ automaticLayout: true, language: 'html' }, data.opts || {});
          editor.updateOptions(options) 
          monaco.editor.setModelLanguage(editor.getModel(), options.language);
        }
        else if(data.type === 'monaco.update.value') {
          editor.setValue(data.value)
        }
        else if(data.type === 'monaco.append.jsonschema') {
          const uri = data.uri
          const schema = data.schema
          if (monaco.languages.json.jsonDefaults.diagnosticsOptions.schemas.some(s => s.uri === uri) === false) {
            const schemas = init.monaco.languages.json.jsonDefaults.diagnosticsOptions.schemas.concat([{ uri, schema }]);
            monaco.languages.json.jsonDefaults.setDiagnosticsOptions({ validate: true, schemas: schemas });
          }
        }
      })
      window.parent.postMessage(JSON.stringify({type:"monaco.created"}), qp.parent);
    });
  </script>
</body>
</html>