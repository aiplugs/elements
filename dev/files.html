<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Files | aiplugs</title>
  <link rel="import" href="/src/index.html" />
  <link rel="import" href="/src/theme.html" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Comfortaa">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/style.css">

  <style>
    :root {
      font-family: var(--base-font-family);
      --bg-image-primary: url('/dev/img/bg.jpg');
      --bg-image-secondary: url('/dev/img/bg.jpg');
    }

    .logo {
      font-family: Comfortaa;
      font-size: 18px;
    }

    html,
    body {
      width: 100%;
      height: 100%;
    }

    body {
      display: flex;
      flex-direction: row;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    aiplugs-file-manager {
      flex: 1;
    }
    nav {
      width: calc(64px + 180px);
      height: 100%;
      background: var(--color-primary);
      color: var(--color-text-inverted);
    }
    nav > ul {
      height: 100%;
    }
    ul, ul li {
      display: flex;
      flex-direction: column;
    }

    ul li .level1 {
      width: 64px;
      font-size: 24px;
      display: inline-block;
      text-align: center;
    }
    ul li a {
      padding: 8px 0;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background linear 0.25s;
    }
    ul li a:hover {
      background: rgba(255,255,255,0.15);      
    }
    ul li a:active, ul li.active a {
      transition: none;      
      background: var(--color-accent);
    }
  </style>
</head>

<body>
    <nav><ul>
      <li>
        <a>
          <span class="level1">
            <img slot="icon" src="img/icon.svg" alt="aiplugs" width="32">
          </span>
          <span class="level2 logo">
            aiplugs CMS
          </span>
        </a>
      </li>
      <li class="active">
        <a>
          <span class="level1">
            <i class="fa fa-folder"></i>
          </span>
          <span class="level2">
            Files
          </span>
        </a>
      </li>
      <li>
        <a>
          <span class="level1">
            <i class="fa fa-database"></i>
          </span>
          <span class="level2">
            Collections
          </span>
        </a>
        <ul>
          <li>
            <a>
              <span class="level1"></span>
              <span class="level2">Blog Posts</span>
            </a>
          </li>
          <li>
            <a>
              <span class="level1"></span>
              <span class="level2">News</span>
            </a>
          </li>
          <li>
            <a>
              <span class="level1"></span>
              <span class="level2">Static Pages</span>
            </a>
          </li>
        </ul>
      </li>
      <li>
          <a>
            <span class="level1">
              <i class="fa fa-cog"></i>
            </span>
            <span class="level2">
              Settings
            </span>
          </a>
          <ul>
            <li>
              <a>
                <span class="level1"></span>
                <span class="level2">Collections</span>
              </a>
            </li>
            <li>
              <a>
                <span class="level1"></span>
                <span class="level2">Users</span>
              </a>
            </li>
            <li>
                <a>
                  <span class="level1"></span>
                  <span class="level2">App Settings</span>
                </a>
              </li>
          </ul>
        </li>
        <li style="flex:1;"></li>
        <li>
            <a>
              <span class="level1">
                <img src="https://avatars2.githubusercontent.com/u/1011232?s=32&u=332a5b77904556e83686f16105a3355f46c82292&v=4" alt="iwate" width="32">
              </span>
              <span class="level2 logo">
                iwate
              </span>
            </a>
          </li>
    </ul></nav>
  <main>
          <aiplugs-file-manager columns="name|lastModifiedAt"
                                label-name="Name"
                                label-size="File Size"
                                label-last-modified-at="Last Update"
                                label-last-modified-by="Last Update User">
            <aiplugs-actions slot="top-actions">
              <button class="btn">Uoload</button>
              <button class="btn" id="new-folder">New Folder</button>
              <button  class="btn one" id="rename">Rename</button>
              <button  class="btn any" id="delete-items">Delete</button>
            </aiplugs-actions>
          </aiplugs-file-manager>
          <script>
            const mgr = document.querySelector("aiplugs-file-manager");
            const loadFolder = path => fetch(`http://localhost:5000/api/storage/${path||''}`).then(res => res.json()).then(data => {
              const folders = data.folders.map(f => Object.assign({ 
                type: 'folder', 
                icon:'&#xf07b'
                }, f, {
                lastModifiedAt: new Date(f.lastModifiedAt).toLocaleString()                  
                }));
              const files = data.files.map(f => Object.assign({
                type: 'file', 
                icon: '&#xf016'
                }, f, { 
                lastModifiedAt:  new Date(f.lastModifiedAt).toLocaleString(),
                size: (~~(f.size / 100)).toLocaleString() + ' kb'
              }));
              mgr.list.items = folders.concat(files);
            }).catch(reason => {
              alert('!!!Fetch Error!!!');
              console.log(reason);
            })
            const loadFile = path => fetch(`http://localhost:5000/api/data/${path}`).then(res => res.blob()).then(blob => {
              mgr.file.preview(blob);
            }).catch(reason => {
              alert('!!!Fetch Error!!!');
              console.log(reason);
            })
            mgr.addEventListener('path.changed', e => {
              loadFolder(e.detail.path.join('/'));
            });
            mgr.addEventListener('file.selected', e => {
              loadFile(e.detail.path.join('/'));
            });
            document.getElementById('new-folder').addEventListener('click', e => {
              const name = window.prompt('Name of new folder', 'New Folder');
              const path = mgr.path.join('/');
              if (name != null) {
                fetch(`http://localhost:5000/api/storage/${path||''}`, {
                  method: 'post', 
                  mode: 'cors',
                  headers: { 
                    'Content-Type': 'application/json'
                  }, 
                  body: JSON.stringify({name})
                }).then(res => {
                  if (res.ok) {
                    mgr.reload();
                  }
                  else {
                    alert(`!!! ERROR !!!\n${res.statusText}`)
                  }
                });
              }
            })
            document.getElementById('delete-items').addEventListener('click', e => {
              const api = {
                folder: 'http://localhost:5000/api/storage/',
                file: 'http://localhost:5000/api/data/',
              }
              const current = mgr.path;
              const items = mgr.checkedItems.map(item => api[item.type] + current.concat([item.name]).join('/'));
              if (confirm('Relay?')) {
                Promise.all(items.map(uri => fetch(uri, { method: 'delete' })))
                .then(arr => {
                  errs = arr.filter(res => !res.ok);
                  if (errs.length > 0) {
                    alert(`!!! ERROR !!!\n${res.errs.map(err => statusText).join('\n')}`)
                  }
                  mgr.reload();
                });
              }
            })
            document.getElementById('rename').addEventListener('click', e => {
              const api = {
                folder: 'http://localhost:5000/api/storage/',
                file: 'http://localhost:5000/api/data/',
              }
              const current = mgr.path;
              const item = mgr.checkedItems[0];
              const name = window.prompt('Name of new folder', item.name); 
              if (name != null) {            
                fetch(api[item.type] + current.concat([item.name]).join('/'), { 
                  method: 'put',
                  mode: 'cors',
                  headers: { 
                    'Content-Type': 'application/json'
                  }, 
                  body: JSON.stringify({name})
                }).then(res => {
                  if (res.ok) {
                    mgr.reload();
                  }
                  else {
                    alert(`!!! ERROR !!!\n${res.statusText}`)
                  }
                });
              }
            })
            mgr.addEventListener('drop', e => {
              const formData = new FormData();
              for(let file of e.detail.files) {
                formData.append('files', file);
              }
              const path = mgr.path.join('/');              
              fetch(`http://localhost:5000/api/data/${path||''}`, {
                method: 'post', 
                body: formData
              }).then(res => {
                if (res.ok) {
                  mgr.reload();
                }
                else {
                  alert(`!!! ERROR !!!\n${res.statusText}`)
                }
              });
            })
            mgr.move();
          </script>
  </main>
  <aiplugs-modal>
    <aiplugs-file-manager columns="name|lastModifiedAt"
          label-name="Name"
          label-size="File Size"
          label-last-modified-at="Last Update"
          label-last-modified-by="Last Update User">
    <aiplugs-actions slot="top-actions">
      <button class="btn">Uoload</button>
    </aiplugs-actions>
    <aiplugs-actions slot="bottom-left-actions">
      <button class="btn">Cancel</button>
    </aiplugs-actions>
    <aiplugs-actions slot="bottom-right-actions">
        <button class="btn block">Select</button>    
    </aiplugs-actions>
  </aiplugs-file-manager>
  </aiplugs-modal>
</body>

</html>