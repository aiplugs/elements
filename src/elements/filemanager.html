<template id="aiplugs-file-manager">
  <style>
    :host {
      display: flex;
      flex-direction: column;
    }

    .vertial {
      display: flex;
      flex-direction: column;
    }

    .horizontal {
      display: flex;
      flex-direction: row;
    }

    .flex {
      flex: 1;
    }

    .side {
      width: 34%;
    }

    aiplugs-breadcrumb {
      border-bottom: 1px solid var(--color-divider);
    }

    aiplugs-file-detail {
      background: var(--color-bg-secondary);
    }

    aiplugs-columnized-list {
      position: relative;
    }

    aiplugs-columnized-list::after {
      font-family: var(--icon-font-family);
      content: var(--icon-upload, "Upload");
      color: var(--color-primary);
      justify-content: center;
      align-items: center;
      font-size: 48px;
      position: absolute;
      display: none;
      background: rgba(255, 255, 255, 0.75);
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }

    aiplugs-columnized-list.dragover::after {
      display: flex;
    }
  </style>
  <aiplugs-breadcrumb></aiplugs-breadcrumb>
  <slot id="top-actions" name="top-actions"></slot>
  <div class="horizontal flex">
    <aiplugs-columnized-list class="flex"></aiplugs-columnized-list>
    <aiplugs-file-detail class="side"></aiplugs-file-detail>
  </div>
  <div class="horizontal">
    <div class="flex">
      <slot name="bottom-left-actions"></slot>
    </div>
    <div class="side">
      <slot name="bottom-right-actions"></slot>
    </div>
  </div>
</template>
<script>
  (function () {
    const LABEL_PREFIX = 'label-';
    const tree = document.currentScript.ownerDocument;
    class FileManager extends HTMLElement {
      constructor() {
        super();
        const template = tree.querySelector('#aiplugs-file-manager').content;
        const shadow = this.attachShadow({ mode: 'open' });
        const clone = template.cloneNode(true);
        shadow.appendChild(clone);

        this.path = [];

        this.breadcrumb = shadow.querySelector('aiplugs-breadcrumb');
        this.list = shadow.querySelector('aiplugs-columnized-list');
        this.file = shadow.querySelector('aiplugs-file-detail');
        this.actions = shadow.querySelectorAll('slot');

        this.breadcrumb.addEventListener('path.selected', e => {
          this.path = e.detail.path;
          this._go();
        })

        this.list.addEventListener('folder.selected', e => {
          const name = e.detail.name;
          this.push(name);
        })

        this.list.addEventListener('file.selected', e => {
          const name = e.detail.name;
          this.file.properties = e.detail;
          this.dispatchEvent(new CustomEvent('file.selected', {
            detail: {
              name: name,
              path: this.path.concat([name])
            }
          }));
        })

        this.list.addEventListener('change', e => {
          const checked = this.list.checkedItems.length;
          const selected = this.selectedItem ? 1 : 0;
          this.actions[0].assignedNodes().forEach(el => el.setAttribute('items', checked + selected));
          this.actions[1].assignedNodes().forEach(el => el.setAttribute('items', checked + selected));
          this.actions[2].assignedNodes().forEach(el => el.setAttribute('items', selected));
        })

        this.list.addEventListener('dragover', e => {
          e.stopPropagation();
          e.preventDefault();
          e.dataTransfer.dropEffect = 'coppy';
        });
        this.list.addEventListener('drop', e => {
          this.list.classList.remove('dragover')
          this.dispatchEvent(new CustomEvent('drop', {
            detail: {
              files: e.dataTransfer.files
            }
          }));
          e.stopPropagation();
          e.preventDefault();
        })
        this.addEventListener('dragenter', () => { this.list.classList.add('dragover') });
        this.addEventListener('dragleave', () => { this.list.classList.remove('dragover') });
      }
      connectedCallback() {
        const columnizedList = this.shadowRoot.querySelector('aiplugs-columnized-list');
        const fileDetail = this.shadowRoot.querySelector('aiplugs-file-detail');
        const attrs = [... this.attributes];
        attrs.filter(attr => attr.name.startsWith(LABEL_PREFIX)).forEach(attr => {
          columnizedList.setAttribute(attr.name, attr.value);
          fileDetail.setAttribute(attr.name, attr.value);
        });
        columnizedList.setAttribute('columns', this.getAttribute('columns') || '');
      }
      push(name) {
        this.path.push(name);
        this._go();
      }
      pop() {
        const name = this.path.pop();
        this._go();
        return name;
      }
      move(path) {
        this.path = !path || path.match(/\s*/) == null ? [] : path.split('/').map(name => name.trim());
        this._go();
      }
      _go() {
        this.breadcrumb.path = this.path;
        this.dispatchEvent(new CustomEvent('path.changed', { detail: { path: this.path } }))
      }
      get selectedItem() {
        return this.list.selectedItem;
      }
      get checkedItems() {
        return this.list.checkedItems;
      }
    }
    window.customElements.define('aiplugs-file-manager', FileManager);
  }())
</script>