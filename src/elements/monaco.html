<template id="aiplugs-monaco">
  <iframe src="./monaco-iframe.html?worker=/dev/js/monaco-editor-worker-loader-proxy.js" style="width: 100%; height: 100%;" scrolling="no" frameborder="0"></iframe>
  <textarea style="display:none;"></textarea>
</template>
<script>
  (function(){
    window.aiplugsMonaco = new URL(document.currentScript.baseURI + "/../monaco-iframe.html").href;
    const tree = document.currentScript.ownerDocument;
    class XMonaco extends HTMLElement {
      constructor() {
        super();
        const template = tree.getElementById('aiplugs-monaco').content;
        const shadow = this.attachShadow({ mode: 'open' });
        const worker = this.getAttribute('worker');
        template.querySelector('iframe').src = window.aiplugsMonaco + `?worker=${worker}`;
        shadow.appendChild(template.cloneNode(true));

        const textarea = shadow.querySelector('textarea');
        const iframe = shadow.querySelector('iframe');
        this._init = new Promise((resolve, reject) => {
          const origin = new URL(window.aiplugsMonaco).origin;
          window.addEventListener('message', evt => {
            if (evt.origin === origin && evt.data === 'monaco.iframe.onload') {
              resolve(evt.source.init);
            }
          })
        }).then(init => {
          this.editor = init.editor;
          this.editor.onDidBlurEditor(() =>{
            textarea.value = this.editor.getValue();
          })
          return init;
        })
        this.el = { textarea };
      }
      static get observedAttributes() {
        return ['options', 'value', 'json-schema', 'name'];
      }
      attributeChangedCallback(attrName, oldVal, newVal) {
        if (attrName === 'options') {
          this._setOptions(JSON.parse(newVal));
        }
        else if (attrName === 'options') {
          this._setValue(newVal);
        }
        else if (attrName === 'json-schema') {
          this._setJsonSchema(newVal);
        }
        else if (attrName === 'name') {
          this.el.textarea.name = newVal;
        }
      }
      _setOptions(opts) {
        const options = Object.assign({ automaticLayout: true, language: 'html' }, opts || this._options ||  {});
        if (JSON.stringify(this._options) !== JSON.stringify(options)) {
          this._options = options;
          this._init.then(init => {
            init.updateOptions(options);
          })
        }
      }
      _setValue(value) {
        this._value = value || this._value || '';
        this._init.then(init => {
          init.editor.setValue(this._value);
        })
      }
      _setJsonSchema(uri) {
        fetch(uri).then(res => res.json()).then(schema => {
          this._init.then(init => {
            if (init.monaco.languages.json.jsonDefaults.diagnosticsOptions.schemas.some(s => s.uri === uri) === false) {
              const schemas = init.monaco.languages.json.jsonDefaults.diagnosticsOptions.schemas.concat([{ uri, schema }]);
              init.monaco.languages.json.jsonDefaults.setDiagnosticsOptions({ validate: true, schemas: schemas });
            }
          })
        }) 
      }
      set options(opts) {
        this.setAttribute('options', opts||'')
      }
      get options() {
        return this.getAttribute('options');
      }
      set value(val) {
        this._init().then(init => {
          init.editor.setValue(val);
          this.el.textarea.value = val;
        })
      }
      get value() {
        return this.el.textarea.value;
      }
    }
    customElements.define('aiplugs-monaco', XMonaco);
  }())
</script>