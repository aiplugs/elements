<template id="aiplugs-monaco">
  <iframe style="width: 100%; height: 100%;" scrolling="no" frameborder="0"></iframe>
  <textarea style="display:none;"></textarea>
</template>
<script>
  (function(){
    const tree = document.currentScript.ownerDocument;
    class XMonaco extends HTMLElement {
      constructor() {
        super();
        const template = tree.getElementById('aiplugs-monaco').content;
        const shadow = this.attachShadow({ mode: 'open' });
        const worker = this.getAttribute('worker');
        template.querySelector('iframe').src = `https://aiplugs.github.io/elements/monaco-iframe.html?parent=${location.origin}`
        shadow.appendChild(template.cloneNode(true));

        const textarea = shadow.querySelector('textarea');
        const iframe = shadow.querySelector('iframe');
        this._init = new Promise((resolve, reject) => {
          const origin = new URL(iframe.src).origin;
          const post = (type, payload) => {
            payload = payload || {}
            payload.type = type
            iframe.contentWindow.postMessage(JSON.stringify(payload), origin)
          } 
          window.addEventListener('message', evt => {
            if (evt.origin !== origin)
              return

            const data = JSON.parse(evt.data)
            if (data.type === 'monaco.created') {
              resolve(post);
            }
            else if (data.type === 'monaco.blur') {
              textarea.value = data.value;
            } 
          })
        });
        this.el = { textarea };
      }
      static get observedAttributes() {
        return ['options', 'value', 'json-schema', 'name'];
      }
      attributeChangedCallback(attrName, oldVal, newVal) {
        if (attrName === 'options') {
          this._setOptions(JSON.parse(newVal));
        }
        else if (attrName === 'options') {
          this._setValue(newVal);
        }
        else if (attrName === 'json-schema') {
          this._setJsonSchema(newVal);
        }
        else if (attrName === 'name') {
          this.el.textarea.name = newVal;
        }
      }
      _setOptions(options) {
        const opts = Object.assign({ automaticLayout: true, language: 'html' }, options ||  {});
        if (JSON.stringify(this._options) !== JSON.stringify(options)) {
          this._init.then(post => {
            post('monaco.update.opts', {opts})
          })
        }
      }
      _setValue(value) {
        this._init.then(post => {
          post('monaco.update.value', {value: value || ''})
        })
      }
      _setJsonSchema(uri) {
        fetch(uri).then(res => res.json()).then(schema => {
          this._init.then(post => {
            post('monaco.append.jsonschema', {uri,schema})
          })
        })
      }
      set value(val) {
        this._setValue(value)
      }
      get value() {
        return this.el.textarea.value;
      }
    }
    customElements.define('aiplugs-monaco', XMonaco);
  }())
</script>