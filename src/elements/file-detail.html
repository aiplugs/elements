<template id="aiplugs-file-detail">
  <style>
    :host {
      display: flex;
      flex-direction: column;
    }

    #preview {
      width: 100%;
      height: 34%;
    }

    #preview>img {
      object-fit: contain;
      width: 100%;
      height: 100%;
    }

    #properties {
      flex: 1;
      list-style: none;
      overflow-x: hidden;
      overflow-y: auto;
      padding: 0 12px;
    }

    #properties>li {
      margin: 12px 0;
      word-wrap: break-word;
    }

    #properties>li>label {
      display: block;
      font-weight: bold;
      font-size: 12px;
      color: var(--color-text-secondary);
    }
  </style>
  <div id="preview">

  </div>
  <ul id="properties">

  </ul>
</template>
<script>
  (function () {
    const LABEL_PREFIX = 'label-';
    const IGNORE_PROPS = ['icon', 'type']
    const tree = document.currentScript.ownerDocument;
    class FileDetail extends HTMLElement {
      constructor() {
        super();
        const template = tree.querySelector('#aiplugs-file-detail').content;
        const shadow = this.attachShadow({ mode: 'open' });
        shadow.appendChild(template.cloneNode(true));

        this.el = {
          preview: shadow.querySelector('#preview'),
          properties: shadow.querySelector('#properties'),
        }

        this.label = {};
        this._properties = {};

        this._initLabel();
      }
      _initLabel() {
        const attrs = [... this.attributes];
        attrs.filter(attr => attr.name.startsWith(LABEL_PREFIX)).forEach(attr => {
          const key = attr.name.substring(LABEL_PREFIX.length).replace(/-/g, '').toLowerCase();
          this.label[key] = attr.value;
        });
      }
      _resolveLabel(key) {
        return this.label[key.toLowerCase()] || key;
      }
      _update() {
        const template = Object.keys(this._properties).map(key => {
          if (IGNORE_PROPS.indexOf(key.toLowerCase()) != -1)
            return null;
          return `<li>
                                <label>${this._resolveLabel(key)}:</label>
                                <span>${this._properties[key]}</span>
                            </li>`
        }).filter(tmpl => tmpl != null).join('');
        this.el.properties.innerHTML = template;
      }
      preview(blob) {
        if (blob.type.indexOf('image') != -1) {
          const reader = new FileReader();
          reader.onload = () => { this.el.preview.innerHTML = `<img src='${reader.result}'/>`; }
          reader.readAsDataURL(blob);
        }
        else {
          this.el.preview.innerHTML = "";
        }
      }
      get properties() {
        return this._properties;
      }
      set properties(value) {
        this._properties = value;
        this._update();
      }
    }
    window.customElements.define('aiplugs-file-detail', FileDetail)
  }())
</script>