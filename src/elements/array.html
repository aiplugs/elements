<template id="aiplugs-array">
  <style>
    aiplugs-array {
      display: block;
      padding-left: 12px;
    }
    aiplugs-array > .container {
      border-left: 1px solid var(--color-primary);
    }
    aiplugs-array > button {
      background: transparent;
      color: var(--color-primary);
      border: 1px solid var(--color-primary);
      border-radius: 50%;
      cursor: pointer;
      font-size: 22px;
      width: 24px;
      height: 24px;
      line-height: 24px;      
      margin-left: -12px;
      padding: 0;
      outline: 0;
      box-shadow: none;
      background-image: none;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    aiplugs-array > button:focus, 
    aiplugs-array > button:active,
    aiplugs-array > button:hover {
      color: var(--color-accent);
      border-color: var(--color-accent);
    }
    aiplugs-array > button:disabled {
      border-color: var(--color-secondary);
      color: var(--color-secondary);
    }
    aiplugs-array > .container > aiplugs-array-item {
      padding-left: 24px;
      margin-top: 12px;
      display: block;
    }
    aiplugs-array > .container > aiplugs-array-item > .close {
      cursor: pointer;
      user-select: none;
      display: inline-block;
      text-align: center;
      float: left;
      width: 12px;
      height:12px;
      font-size: 24px;
      line-height: 12px;
      margin-left: -31.2px;
      background: var(--color-base);
      color: transparent;
      border: 1px solid var(--color-primary);
      border-radius: 50%;
      transition: all linear .25s;
    }
    aiplugs-array > .container > aiplugs-array-item > .close ~ * {
      transition: all linear .25s;
    } 
    aiplugs-array > .container > aiplugs-array-item > .close:hover {
      color: var(--color-primary-dark);
      color: var(--color-primary);
      border-style:none;
    }
    aiplugs-array > .container > aiplugs-array-item > .close:hover ~ * {
      opacity: 0.3;
    } 
    aiplugs-array > .unremovable > aiplugs-array-item > .close {
      display:none;
    }
  </style>
  <div class="container"></div>
  <button type="button">+</button>
</template>

<script>
  (function(){
    const tree = document.currentScript.ownerDocument;
    class XArray extends HTMLElement {
      constructor() {
        super();
      }
      connectedCallback() {
        const template = tree.getElementById('aiplugs-array').content;

        this.appendChild(template.cloneNode(true));

        const container = this.querySelector('.container');
        const addBtn = this.querySelector('button');
        const itemTemplate = this.querySelector('template');

        addBtn.addEventListener('click', e => { 
          this._add(); 
          this._update();
        });

        setTimeout(() => {
          this._init();
        }, 0);
        
        this.el = { container, addBtn, itemTemplate };        
      }
      _init () {
        this._indexer = this._createIndexer();
        for (let item of this.querySelectorAll('aiplugs-array-item')) {
          this.el.container.appendChild(this._createItem(item));
        }
        for (let i = this.min - this.items.length; i > 0; i--) {
          this._add();
        }
        if (this.max != 0 && this.items.length == 0) {
          this._add();
        }
        this._update();
      }
      
      get itemTemplate () {
        return this.querySelector('template');
      }

      get min() {
        const min =  parseInt(this.getAttribute('min')) || 0;
        
        if (min < 0)
          return 0;

        return min;
      }
      
      get max() {
        const max = parseInt(this.getAttribute('max'));
        if (isNaN(max))
          return '*';
        
        if (max < 0)
          return 0;

        return max;
      }
      get items() {
        return this.el.container.querySelectorAll(':scope > aiplugs-array-item');
      }
      _createIndexer() {
        let index = parseInt(this.getAttribute('index'));
        return function() { return index++; }
      }
      _canAdd() {
        if (!this.itemTemplate)
          return false;

        if (!this.itemTemplate.content)
          return false;

        if (this.max == '*')
          return true;

        if (this.items.length >= this.max)
          return false;

        return true;
      }
      _createItem(item) {
        if (!item) {
          const template = document.createElement('template');
          template.innerHTML = this.itemTemplate.innerHTML.replace(/{{index}}/g, this._indexer());
          item = new XArrayItem();
          item.appendChild(template.content.cloneNode(true));
        }
        const rm = document.createElement('a');
        rm.classList.add('close');
        rm.innerHTML = '&times;';
        rm.addEventListener('click', e => {
          item.remove();
          requestIdleCallback(() => {
            this._update();
          })
        });
        item.insertBefore(rm, item.firstChild);
        return item;
      }
      _add() {
        if (this._canAdd()) {
          const item = this._createItem();
          this.el.container.appendChild(item);
        }
      }
      _update() {
        const items = this.items.length;
        if (items >= this.max) {
          this.el.addBtn.setAttribute('disabled', '');
        }
        else {
          this.el.addBtn.removeAttribute('disabled');
        }

        if (this.min != this.max && items > this.min) {
          this.el.container.classList.remove('unremovable');
        }
        else {
          this.el.container.classList.add('unremovable');
        }
      }
    }
    window.customElements.define('aiplugs-array', XArray);

    class XArrayItem extends HTMLElement {
      constructor() {
        super();
      }
    }
    window.customElements.define('aiplugs-array-item', XArrayItem);
  }())
</script>